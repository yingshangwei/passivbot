# Passivbot 交易策略流程图

## 整体策略架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Passivbot 交易策略架构                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  反向做市   │    │  网格交易   │    │  追踪订单   │         │
│  │ 策略核心    │    │ 系统       │    │ 系统       │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                   │                   │              │
│         └───────────────────┼───────────────────┘              │
│                             │                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  解套机制   │    │  风险管理   │    │  EMA指标   │         │
│  │             │    │  系统       │    │  系统       │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 策略执行流程图

```
开始
  │
  ▼
┌─────────────────┐
│   初始化系统    │
│ - 加载配置      │
│ - 连接交易所    │
│ - 计算EMA指标   │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│   市场数据更新  │
│ - 获取订单簿    │
│ - 更新价格数据  │
│ - 计算技术指标  │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│   策略决策      │
│ - 检查过滤条件  │
│ - 计算入场信号  │
│ - 计算平仓信号  │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│   订单管理      │
│ - 创建新订单    │
│ - 更新现有订单  │
│ - 取消过期订单  │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│   风险检查      │
│ - 检查仓位限制  │
│ - 检查资金风险  │
│ - 检查解套条件  │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│   执行交易      │
│ - 提交订单      │
│ - 监控执行      │
│ - 更新仓位      │
└─────────────────┘
  │
  ▼
┌─────────────────┐
│   记录日志      │
│ - 交易记录      │
│ - 性能统计      │
│ - 错误日志      │
└─────────────────┘
  │
  ▼
    等待下一周期
```

## 网格交易流程图

```
价格下跌 → 触发买入网格
    │
    ▼
┌─────────────────┐
│   计算入场价格  │
│ - 基于EMA下轨   │
│ - 考虑订单簿    │
│ - 应用网格间距  │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   计算入场数量  │
│ - 初始数量      │
│ - 加倍因子      │
│ - 风险限制      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   放置买单      │
│ - 限价单        │
│ - 网格价格      │
│ - 计算数量      │
└─────────────────┘
    │
    ▼
价格反弹 → 触发平仓网格
    │
    ▼
┌─────────────────┐
│   计算平仓价格  │
│ - 基于成本价    │
│ - 应用利润标记  │
│ - 考虑滑点      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   计算平仓数量  │
│ - 平仓比例      │
│ - 分批平仓      │
│ - 风险控制      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   放置卖单      │
│ - 限价单        │
│ - 平仓价格      │
│ - 计算数量      │
└─────────────────┘
```

## 追踪订单流程图

```
价格移动超过阈值
    │
    ▼
┌─────────────────┐
│   启动追踪      │
│ - 记录最高价    │
│ - 设置回调条件  │
│ - 监控价格      │
└─────────────────┘
    │
    ▼
价格回调触发条件
    │
    ▼
┌─────────────────┐
│   计算追踪价格  │
│ - 当前价格      │
│ - 回调比例      │
│ - 订单簿价格    │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   执行追踪订单  │
│ - 市价单/限价单 │
│ - 追踪数量      │
│ - 风险控制      │
└─────────────────┘
```

## 解套机制流程图

```
检测到卡住仓位
    │
    ▼
┌─────────────────┐
│   分析仓位状态  │
│ - 计算亏损      │
│ - 检查EMA距离   │
│ - 评估解套条件  │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   选择解套策略  │
│ - 优先最近仓位  │
│ - 计算解套价格  │
│ - 限制损失      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   执行解套      │
│ - 小额亏损平仓  │
│ - 释放资金      │
│ - 记录损失      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   重新分配资金  │
│ - 寻找新机会    │
│ - 调整策略      │
│ - 继续交易      │
└─────────────────┘
```

## 风险管理流程图

```
交易决策
    │
    ▼
┌─────────────────┐
│   仓位风险检查  │
│ - 当前仓位大小  │
│ - 钱包风险敞口  │
│ - 单币种限制    │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   资金风险检查  │
│ - 可用余额      │
│ - 保证金要求    │
│ - 杠杆倍数      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   市场风险检查  │
│ - 波动率过滤    │
│ - 成交量过滤    │
│ - 噪音过滤      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   风险决策      │
│ - 允许交易      │
│ - 调整参数      │
│ - 拒绝交易      │
└─────────────────┘
```

## 参数优化流程图

```
开始优化
    │
    ▼
┌─────────────────┐
│   设置优化目标  │
│ - 夏普比率      │
│ - 最大回撤      │
│ - 总收益率      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   生成参数组合  │
│ - 网格参数      │
│ - 追踪参数      │
│ - 风险参数      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   运行回测      │
│ - 历史数据      │
│ - 策略执行      │
│ - 性能计算      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   评估结果      │
│ - 计算指标      │
│ - 风险分析      │
│ - 排名排序      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│   进化算法      │
│ - 选择优秀个体  │
│ - 交叉变异      │
│ - 生成新参数    │
└─────────────────┘
    │
    ▼
    达到迭代次数？
    │
    ▼
┌─────────────────┐
│   输出最优参数  │
│ - 最佳配置      │
│ - 性能报告      │
│ - 风险分析      │
└─────────────────┘
```

## 策略组合图

```
┌─────────────────────────────────────────────────────────────────┐
│                        策略组合架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  多头策略                   空头策略                            │
│  ┌─────────────┐           ┌─────────────┐                     │
│  │ 网格入场    │           │ 网格入场    │                     │
│  │ 间距: 2.7%  │           │ 间距: 3.7%  │                     │
│  │ 加倍: 0.85  │           │ 加倍: 3.41  │                     │
│  └─────────────┘           └─────────────┘                     │
│           │                           │                        │
│           ▼                           ▼                        │
│  ┌─────────────┐           ┌─────────────┐                     │
│  │ 追踪入场    │           │ 追踪入场    │                     │
│  │ 阈值: 6.5%  │           │ 阈值: 6.5%  │                     │
│  │ 回调: 1.4%  │           │ 回调: 1.4%  │                     │
│  └─────────────┘           └─────────────┘                     │
│           │                           │                        │
│           ▼                           ▼                        │
│  ┌─────────────┐           ┌─────────────┐                     │
│  │ 网格平仓    │           │ 网格平仓    │                     │
│  │ 起始: 0.6%  │           │ 起始: 2.0%  │                     │
│  │ 比例: 94%   │           │ 比例: 5.2%  │                     │
│  └─────────────┘           └─────────────┘                     │
│           │                           │                        │
│           ▼                           ▼                        │
│  ┌─────────────┐           ┌─────────────┐                     │
│  │ 追踪平仓    │           │ 追踪平仓    │                     │
│  │ 阈值: 5.1%  │           │ 阈值: -0.9% │                     │
│  │ 比例: 27%   │           │ 比例: 7.4%  │                     │
│  └─────────────┘           └─────────────┘                     │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                共同风险管理                              │   │
│  │  - 钱包风险限制: 200%                                   │   │
│  │  - 解套机制: 68%阈值                                    │   │
│  │  - EMA指标: 多头(279/476), 空头(1365/985)              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

*这些流程图展示了Passivbot交易策略的完整执行逻辑和各个组件之间的关系*
