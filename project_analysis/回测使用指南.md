# Passivbot 回测使用指南

## 回测功能概述

Passivbot 提供了强大的回测功能，可以让你在历史数据上测试交易策略，评估策略性能，并优化参数。

## 回测方式

### 1. 完整回测（需要网络连接）

#### 使用官方回测系统
```bash
# 基本回测命令
python src/backtest.py config.json

# 禁用图表生成（加快速度）
python src/backtest.py config.json --disable_plotting

# 指定回测时间范围
python src/backtest.py config.json --backtest.start_date 2024-01-01 --backtest.end_date 2024-06-01
```

#### 回测配置示例
```json
{
  "backtest": {
    "base_dir": "backtests",
    "combine_ohlcvs": true,
    "compress_cache": true,
    "end_date": "2024-06-01",
    "exchanges": ["binance", "bybit"],
    "gap_tolerance_ohlcvs_minutes": 120,
    "start_date": "2024-01-01",
    "starting_balance": 10000,
    "use_btc_collateral": true
  },
  "bot": {
    "long": {
      "entry_grid_spacing_pct": 0.027,
      "close_grid_markup_start": 0.006,
      "n_positions": 7
    }
  },
  "live": {
    "approved_coins": ["BTCUSDT", "ETHUSDT"]
  }
}
```

### 2. 离线回测（无需网络连接）

#### 使用离线回测演示
```bash
# 运行离线回测演示
python offline_backtest_demo.py
```

这个演示脚本会：
1. 生成模拟的OHLCV数据
2. 实现简单的网格策略
3. 运行回测并显示结果
4. 保存结果到JSON文件

## 回测结果分析

### 关键指标

1. **收益率指标**
   - 总收益率：`(最终资金 - 初始资金) / 初始资金 * 100%`
   - 年化收益率：考虑时间因素的年化收益
   - 最大回撤：最大亏损幅度

2. **交易指标**
   - 总交易次数：买入和卖出次数
   - 胜率：盈利交易占总交易的比例
   - 平均盈利：平均每笔交易的利润

3. **风险指标**
   - 夏普比率：风险调整后的收益
   - 索提诺比率：下行风险调整后的收益
   - VaR：风险价值

### 示例回测结果

```
==================================================
回测结果
==================================================
初始资金: $10,000.00
最终资金: $10,144.21
总收益率: 1.44%
总交易次数: 68
买入次数: 35
卖出次数: 33
总利润: $152.50
剩余仓位: 2
```

## 回测最佳实践

### 1. 数据准备

#### 数据质量检查
- 确保数据完整性，没有缺失值
- 检查数据时间戳的连续性
- 验证价格数据的合理性

#### 数据时间范围
- 建议使用至少3个月的历史数据
- 包含不同的市场条件（牛市、熊市、震荡市）
- 避免使用过短的时间段

### 2. 策略参数设置

#### 网格参数
```json
{
  "entry_grid_spacing_pct": 0.027,  // 网格间距
  "entry_initial_qty_pct": 0.016,   // 初始仓位比例
  "n_positions": 7,                  // 最大仓位数量
  "close_grid_markup_start": 0.006   // 止盈标记
}
```

#### 风险管理参数
```json
{
  "total_wallet_exposure_limit": 2,  // 总风险敞口限制
  "unstuck_threshold": 0.68,         // 解套阈值
  "unstuck_loss_allowance_pct": 0.002 // 解套损失容忍度
}
```

### 3. 回测验证

#### 样本外测试
- 使用不同时间段的数据验证策略稳定性
- 进行滚动窗口回测
- 交叉验证策略参数

#### 敏感性分析
- 测试参数变化对结果的影响
- 识别关键参数
- 评估策略鲁棒性

## 回测工具

### 1. 数据下载工具
```bash
# 下载历史数据
python src/downloader.py config.json

# 指定交易所和币种
python src/downloader.py config.json --backtest.exchanges binance --live.approved_coins BTCUSDT,ETHUSDT
```

### 2. 优化工具
```bash
# 运行参数优化
python src/optimize.py config.json

# 指定优化参数
python src/optimize.py config.json --optimize.iters 1000 --optimize.population_size 50
```

### 3. 可视化工具
```bash
# 生成回测图表
python src/plotting.py --config config.json

# 交互式图表
python src/interactive_plot.py
```

## 回测结果文件

### 文件结构
```
backtests/
├── binance/
│   └── BTCUSDT/
│       ├── backtest_result.json    # 回测结果
│       ├── plots/                  # 图表文件
│       └── caches/                 # 数据缓存
│           ├── ohlcvs_1m.npy       # OHLCV数据
│           └── timestamps_1m.npy   # 时间戳数据
```

### 结果文件内容
- `backtest_result.json`：详细的回测结果
- `plots/`：各种分析图表
- `caches/`：原始数据和缓存文件

## 常见问题

### 1. 网络连接问题
**问题**：回测时出现网络超时错误
**解决方案**：
- 使用离线回测演示
- 检查网络连接
- 使用VPN或代理

### 2. 数据缺失问题
**问题**：某些时间段的数据缺失
**解决方案**：
- 调整`gap_tolerance_ohlcvs_minutes`参数
- 重新下载数据
- 使用不同的交易所数据

### 3. 内存不足问题
**问题**：处理大量数据时内存不足
**解决方案**：
- 减少回测时间范围
- 使用数据压缩
- 分批处理数据

## 回测策略开发

### 1. 自定义策略回测
```python
# 使用策略插件系统进行回测
from strategies.strategy_manager import StrategyManager
from strategies.ma_crossover_strategy import MACrossoverStrategy

# 注册策略
manager = StrategyManager()
manager.register_strategy('ma_crossover', MACrossoverStrategy)

# 加载策略
strategy = manager.load_strategy('ma_crossover', config)
```

### 2. 策略参数优化
```json
{
  "strategy": {
    "name": "ma_crossover",
    "params": {
      "fast_period": 10,
      "slow_period": 20,
      "position_size": 0.1
    }
  }
}
```

## 总结

Passivbot的回测功能提供了：

1. **完整的回测系统** - 支持历史数据回测
2. **离线回测能力** - 无需网络连接即可测试
3. **策略插件支持** - 可以测试自定义策略
4. **参数优化** - 自动寻找最优参数
5. **结果分析** - 详细的性能指标和图表

通过合理使用回测功能，你可以：
- 验证策略有效性
- 优化策略参数
- 评估风险收益
- 提高交易成功率

---

*本指南涵盖了Passivbot回测功能的完整使用方法，包括在线和离线回测方式*
