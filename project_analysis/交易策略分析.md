# Passivbot 交易策略深度分析

## 策略概述

Passivbot 采用了一套复杂的**反向做市策略**，结合了**网格交易**、**追踪订单**和**解套机制**，形成了一个完整的自动化交易系统。该策略不预测价格走势，而是通过提供流动性来获取收益。

## 核心策略架构

### 1. 反向做市策略 (Contrarian Market Making)

#### 核心理念
- **不预测价格**：策略不依赖技术分析或价格预测
- **提供流动性**：作为价格稳定器，为市场提供双向流动性
- **反向操作**：在价格下跌时买入，价格上涨时卖出
- **均值回归**：假设价格会围绕某个均值波动

#### 实现机制
```rust
// 入场价格计算 - 基于EMA和订单簿
let initial_entry_price = calc_ema_price_bid(
    exchange_params.price_step,
    state_params.order_book.bid,
    state_params.ema_bands.lower,
    bot_params.entry_initial_ema_dist,
);
```

### 2. 网格交易系统 (Grid Trading)

#### 2.1 入场网格 (Entry Grid)

**多头入场网格**：
- **初始入场**：基于EMA下轨和订单簿买价
- **网格间距**：`entry_grid_spacing_pct = 0.027` (2.7%)
- **加倍因子**：`entry_grid_double_down_factor = 0.85`
- **仓位数量**：`n_positions = 7`

**空头入场网格**：
- **初始入场**：基于EMA上轨和订单簿卖价
- **网格间距**：`entry_grid_spacing_pct = 0.037` (3.7%)
- **加倍因子**：`entry_grid_double_down_factor = 3.41`
- **仓位数量**：`n_positions = 7`

#### 2.2 平仓网格 (Close Grid)

**多头平仓网格**：
- **起始标记**：`close_grid_markup_start = 0.006` (0.6%)
- **结束标记**：`close_grid_markup_end = 0.003` (0.3%)
- **平仓比例**：`close_grid_qty_pct = 0.94` (94%)

**空头平仓网格**：
- **起始标记**：`close_grid_markup_start = 0.020` (2.0%)
- **结束标记**：`close_grid_markup_end = 0.002` (0.2%)
- **平仓比例**：`close_grid_qty_pct = 0.052` (5.2%)

#### 2.3 网格计算逻辑

```rust
// 重新入场价格计算
let reentry_price = calc_reentry_price_bid(
    position.price,           // 当前仓位价格
    wallet_exposure,          // 钱包风险敞口
    state_params.order_book.bid,  // 订单簿买价
    exchange_params,          // 交易所参数
    bot_params,              // 机器人参数
);

// 重新入场数量计算
let reentry_qty = f64::max(
    calc_reentry_qty(
        reentry_price,
        state_params.balance,
        position.size,
        bot_params.entry_grid_double_down_factor,  // 加倍因子
        exchange_params,
        bot_params,
    ),
    initial_entry_qty,
);
```

### 3. 追踪订单系统 (Trailing Orders)

#### 3.1 追踪入场 (Trailing Entry)

**触发条件**：
- **阈值**：`entry_trailing_threshold_pct = 0.065` (6.5%)
- **回调**：`entry_trailing_retracement_pct = 0.014` (1.4%)
- **加倍因子**：`entry_trailing_double_down_factor = 3.04`

**工作原理**：
1. 等待价格移动超过阈值
2. 价格回调指定百分比后触发入场
3. 动态调整入场价格和数量

#### 3.2 追踪平仓 (Trailing Close)

**多头追踪平仓**：
- **阈值**：`close_trailing_threshold_pct = 0.051` (5.1%)
- **回调**：`close_trailing_retracement_pct = 0.0007` (0.07%)
- **平仓比例**：`close_trailing_qty_pct = 0.27` (27%)

**空头追踪平仓**：
- **阈值**：`close_trailing_threshold_pct = -0.009` (-0.9%)
- **回调**：`close_trailing_retracement_pct = 0.004` (0.4%)
- **平仓比例**：`close_trailing_qty_pct = 0.074` (7.4%)

### 4. 解套机制 (Unstucking Mechanism)

#### 4.1 解套触发条件
- **解套阈值**：`unstuck_threshold = 0.68` (68%)
- **EMA距离**：`unstuck_ema_dist = 0.003` (0.3%)
- **损失容忍**：`unstuck_loss_allowance_pct = 0.002` (0.2%)

#### 4.2 解套策略
```rust
pub fn calc_unstucking_close(self) -> (float, float, str, int):
    // 计算解套平仓价格和数量
    // 优先处理最接近当前价格的仓位
    // 限制单次损失不超过设定值
```

### 5. 风险管理系统

#### 5.1 仓位管理
- **钱包风险限制**：`total_wallet_exposure_limit = 2` (200%)
- **单币种风险**：`wallet_exposure_limit = 2` (200%)
- **强制风险限制**：`enforce_exposure_limit = true`

#### 5.2 过滤机制
- **噪音过滤**：`filter_noisiness_rolling_window = 40`
- **成交量过滤**：`filter_volume_drop_pct = 0.51` (51%)
- **成交量窗口**：`filter_volume_rolling_window = 1886`

#### 5.3 EMA指标
- **多头EMA**：`ema_span_0 = 279`, `ema_span_1 = 476`
- **空头EMA**：`ema_span_0 = 1365`, `ema_span_1 = 985`

## 策略执行流程

### 1. 初始化阶段
1. 计算EMA指标
2. 确定初始入场价格
3. 计算初始入场数量
4. 设置网格参数

### 2. 入场阶段
1. **网格入场**：
   - 在预设价格点放置买单/卖单
   - 根据仓位大小调整订单数量
   - 使用加倍因子增加仓位

2. **追踪入场**：
   - 监控价格移动
   - 等待回调触发
   - 动态调整入场时机

### 3. 平仓阶段
1. **网格平仓**：
   - 在预设利润点放置平仓单
   - 分批平仓锁定利润
   - 根据风险调整平仓比例

2. **追踪平仓**：
   - 跟随价格移动
   - 在回调时平仓
   - 最大化利润捕获

### 4. 解套阶段
1. 识别卡住仓位
2. 计算解套价格
3. 执行小额亏损平仓
4. 释放资金用于新机会

## 策略参数分析

### 关键参数对比

| 参数 | 多头 | 空头 | 说明 |
|------|------|------|------|
| 网格间距 | 2.7% | 3.7% | 空头网格更宽，适应波动性 |
| 加倍因子 | 0.85 | 3.41 | 空头加倍更激进 |
| 平仓起始 | 0.6% | 2.0% | 空头需要更高利润 |
| 平仓比例 | 94% | 5.2% | 多头更倾向于快速平仓 |
| EMA周期 | 279/476 | 1365/985 | 空头使用更长周期 |

### 参数优化策略

#### 1. 网格参数优化
- **间距优化**：根据波动率调整网格间距
- **加倍因子**：平衡风险和收益
- **仓位数量**：控制总风险敞口

#### 2. 追踪参数优化
- **阈值设置**：平衡触发频率和利润
- **回调比例**：优化入场/平仓时机
- **数量比例**：控制追踪订单影响

#### 3. 风险管理优化
- **风险限制**：根据资金规模调整
- **过滤参数**：提高信号质量
- **解套参数**：平衡损失和机会成本

## 策略优势

### 1. 市场适应性
- **双向交易**：同时做多和做空
- **动态调整**：根据市场条件调整参数
- **多时间框架**：结合短期和长期EMA

### 2. 风险控制
- **分散投资**：多币种、多交易所
- **仓位管理**：严格的仓位限制
- **止损机制**：解套机制防止大额亏损

### 3. 收益优化
- **网格收益**：从价格波动中获利
- **追踪收益**：捕获趋势性利润
- **复利效应**：持续的资金周转

## 策略风险

### 1. 市场风险
- **趋势市场**：在强趋势中可能亏损
- **流动性风险**：市场流动性不足时执行困难
- **滑点风险**：大单执行时的价格滑点

### 2. 技术风险
- **系统故障**：网络中断、服务器故障
- **API限制**：交易所API调用限制
- **数据延迟**：市场数据延迟影响决策

### 3. 参数风险
- **过度优化**：参数过度拟合历史数据
- **市场变化**：市场结构变化导致策略失效
- **资金管理**：不当的资金管理导致爆仓

## 策略改进建议

### 1. 动态参数调整
- 根据市场波动率动态调整网格间距
- 根据趋势强度调整追踪参数
- 根据流动性调整订单大小

### 2. 多策略组合
- 结合趋势跟踪策略
- 加入套利策略
- 整合基本面分析

### 3. 风险管理增强
- 增加VaR风险模型
- 实施动态止损
- 加入相关性分析

## 总结

Passivbot的交易策略是一个复杂的多维度系统，通过网格交易、追踪订单和解套机制的有机结合，实现了在加密货币市场中的自动化交易。该策略的核心优势在于其适应性和风险控制能力，但也存在一定的市场风险和技术风险。

成功使用该策略需要：
1. 充分理解策略逻辑
2. 合理设置参数
3. 严格的风险管理
4. 持续的监控和调整

---

*本分析基于Passivbot v7.3.20的源代码和配置参数*
