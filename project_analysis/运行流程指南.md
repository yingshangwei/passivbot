# Passivbot 运行流程指南

## 🚀 完整运行流程

### 第一步：环境准备

#### 1.1 激活虚拟环境
```bash
# 进入项目目录
cd /Users/shangwei.ying/workspace/git/passivbot

# 激活虚拟环境
source venv/bin/activate

# 验证环境
python --version  # 应该显示 Python 3.13.3
```

#### 1.2 验证依赖
```bash
# 测试核心模块导入
python -c "
import passivbot_rust
import ccxt
import pandas as pd
import numpy as np
print('✅ 所有依赖正常')
"
```

### 第二步：配置设置

#### 2.1 配置API密钥
```bash
# 编辑API密钥文件
nano api-keys.json
```

**API密钥配置示例**:
```json
{
  "binance": {
    "api_key": "your_binance_api_key",
    "secret": "your_binance_secret",
    "sandbox": false
  },
  "bybit": {
    "api_key": "your_bybit_api_key", 
    "secret": "your_bybit_secret",
    "sandbox": false
  }
}
```

#### 2.2 创建交易配置
```bash
# 复制配置模板
cp configs/template.json my_config.json

# 编辑配置文件
nano my_config.json
```

**关键配置参数说明**:
```json
{
  "live": {
    "user": "your_account_name",  // 对应api-keys.json中的账户名
    "approved_coins": ["BTCUSDT", "ETHUSDT"],  // 允许交易的币种
    "leverage": 1.0,  // 杠杆倍数
    "market_orders_allowed": false  // 是否允许市价单
  },
  "bot": {
    "long": {
      "n_positions": 7,  // 多头仓位数量
      "entry_grid_spacing_pct": 0.027,  // 入场网格间距
      "close_grid_markup_start": 0.006  // 平仓网格起始标记
    },
    "short": {
      "n_positions": 7,  // 空头仓位数量
      "entry_grid_spacing_pct": 0.037,  // 入场网格间距
      "close_grid_markup_start": 0.020  // 平仓网格起始标记
    }
  }
}
```

### 第三步：数据准备

#### 3.1 下载历史数据（用于回测）
```bash
# 下载币安数据
python src/downloader.py --exchange binance --symbols BTCUSDT,ETHUSDT --timeframes 1m --start_date 2024-01-01 --end_date 2024-12-01

# 下载Bybit数据
python src/downloader.py --exchange bybit --symbols BTCUSDT,ETHUSDT --timeframes 1m --start_date 2024-01-01 --end_date 2024-12-01
```

#### 3.2 验证数据完整性
```bash
# 检查下载的数据
ls -la backtests/
```

### 第四步：策略回测

#### 4.1 单币种回测
```bash
# 回测BTCUSDT
python src/backtest.py my_config.json --live.approved_coins BTCUSDT --backtest.start_date 2024-01-01 --backtest.end_date 2024-06-01
```

#### 4.2 多币种回测
```bash
# 回测多个币种
python src/backtest.py my_config.json --live.approved_coins BTCUSDT,ETHUSDT --backtest.start_date 2024-01-01 --backtest.end_date 2024-06-01
```

#### 4.3 查看回测结果
```bash
# 查看回测结果文件
ls -la backtests/binance/BTCUSDT/

# 查看性能报告
cat backtests/binance/BTCUSDT/backtest_result.json
```

### 第五步：参数优化

#### 5.1 运行优化器
```bash
# 基础优化（小规模测试）
python src/optimize.py my_config.json --optimize.iters 100 --optimize.population_size 20

# 完整优化（需要较长时间）
python src/optimize.py my_config.json --optimize.iters 1000 --optimize.population_size 50
```

#### 5.2 查看优化结果
```bash
# 查看优化结果
ls -la backtests/binance/BTCUSDT/optimize/

# 查看最佳配置
cat backtests/binance/BTCUSDT/optimize/best_result.json
```

### 第六步：实盘交易

#### 6.1 模拟交易测试
```bash
# 使用模拟模式测试（如果交易所支持）
python src/main.py my_config.json --live.user your_account_name
```

#### 6.2 实盘交易启动
```bash
# 启动实盘交易（谨慎操作！）
python src/main.py my_config.json --live.user your_account_name
```

#### 6.3 监控交易状态
```bash
# 查看实时日志
tail -f logs/passivbot.log

# 查看交易状态
python src/tools/fetch_balance.py --user your_account_name
```

### 第七步：结果分析

#### 7.1 生成交易报告
```bash
# 生成性能分析图表
python src/plotting.py --config my_config.json --start_date 2024-01-01 --end_date 2024-12-01
```

#### 7.2 交互式分析
```bash
# 启动交互式图表
python src/interactive_plot.py
```

## 🔧 常用命令速查

### 环境管理
```bash
# 激活环境
source venv/bin/activate

# 退出环境
deactivate

# 检查环境
which python
pip list
```

### 配置管理
```bash
# 查看配置模板
cat configs/template.json

# 验证配置文件
python -c "
import json
with open('my_config.json', 'r') as f:
    config = json.load(f)
    print('配置验证通过')
"
```

### 数据管理
```bash
# 清理缓存数据
rm -rf backtests/*/cache/

# 压缩历史数据
python src/downloader.py --compress_cache true
```

### 监控命令
```bash
# 查看系统资源
htop

# 查看磁盘使用
df -h

# 查看网络连接
netstat -an | grep ESTABLISHED
```

## 📊 性能监控

### 关键指标监控
1. **收益率**: 总收益、年化收益、最大回撤
2. **风险指标**: 夏普比率、索提诺比率、VaR
3. **交易统计**: 交易次数、胜率、平均持仓时间
4. **系统指标**: CPU使用率、内存使用、网络延迟

### 监控脚本示例
```bash
#!/bin/bash
# monitor.sh - 交易监控脚本

while true; do
    echo "=== $(date) ==="
    
    # 检查进程状态
    ps aux | grep passivbot
    
    # 检查日志错误
    tail -n 10 logs/passivbot.log | grep ERROR
    
    # 检查账户余额
    python src/tools/fetch_balance.py --user your_account_name
    
    sleep 300  # 每5分钟检查一次
done
```

## 🚨 故障排除

### 常见问题及解决方案

#### 1. API连接问题
```bash
# 检查网络连接
ping api.binance.com
ping api.bybit.com

# 检查API密钥
python -c "
import ccxt
exchange = ccxt.binance({
    'apiKey': 'your_key',
    'secret': 'your_secret',
    'sandbox': True
})
print(exchange.fetch_balance())
"
```

#### 2. 数据下载问题
```bash
# 清理并重新下载
rm -rf backtests/binance/BTCUSDT/
python src/downloader.py --exchange binance --symbols BTCUSDT --timeframes 1m --start_date 2024-01-01
```

#### 3. 内存不足
```bash
# 减少并发数量
python src/optimize.py my_config.json --optimize.n_cpus 2

# 清理临时文件
find . -name "*.tmp" -delete
```

#### 4. 配置错误
```bash
# 验证配置语法
python -c "
import hjson
with open('my_config.json', 'r') as f:
    config = hjson.load(f)
    print('配置语法正确')
"
```

## 📈 最佳实践

### 1. 风险管理
- 设置合理的仓位大小
- 使用止损机制
- 定期检查风险指标
- 分散投资多个币种

### 2. 参数调优
- 先进行充分回测
- 使用优化器寻找最佳参数
- 定期重新优化参数
- 避免过度拟合

### 3. 系统维护
- 定期更新依赖包
- 监控系统资源使用
- 备份重要配置文件
- 保持日志记录

### 4. 安全措施
- 使用API密钥权限限制
- 定期更换API密钥
- 监控异常交易活动
- 设置资金使用上限

## 🔄 自动化部署

### 使用systemd服务（Linux）
```bash
# 创建服务文件
sudo nano /etc/systemd/system/passivbot.service

[Unit]
Description=Passivbot Trading Bot
After=network.target

[Service]
Type=simple
User=your_username
WorkingDirectory=/path/to/passivbot
ExecStart=/path/to/passivbot/venv/bin/python src/main.py my_config.json
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target

# 启动服务
sudo systemctl enable passivbot
sudo systemctl start passivbot
```

### 使用Docker部署
```bash
# 构建镜像
docker build -t passivbot .

# 运行容器
docker run -d --name passivbot \
  -v $(pwd)/configs:/app/configs \
  -v $(pwd)/logs:/app/logs \
  passivbot
```

## 📝 日志管理

### 日志配置
```bash
# 创建日志目录
mkdir -p logs

# 配置日志轮转
sudo nano /etc/logrotate.d/passivbot

/path/to/passivbot/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 your_username your_username
}
```

### 日志分析
```bash
# 查看错误日志
grep ERROR logs/passivbot.log

# 统计交易次数
grep "Trade executed" logs/passivbot.log | wc -l

# 查看性能指标
grep "PnL" logs/passivbot.log | tail -10
```

---

*本指南涵盖了Passivbot的完整运行流程，从环境准备到实盘交易的全过程。请根据实际情况调整配置参数，并始终注意风险管理。*
