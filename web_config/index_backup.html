<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passivbot 增强版配置平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #007bff;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 500;
            color: #495057;
        }

        .status-value {
            color: #6c757d;
        }

        .status-value.success {
            color: #28a745;
        }

        .status-value.error {
            color: #dc3545;
        }

        .status-value.warning {
            color: #ffc107;
        }

        .results-panel {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .results-section {
            margin-bottom: 20px;
        }

        .results-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 5px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .config-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .config-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .config-section h6 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .config-params {
            display: grid;
            gap: 8px;
        }

        .config-param {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .config-param:last-child {
            border-bottom: none;
        }

        .param-name {
            font-weight: 500;
            color: #495057;
            font-size: 0.9em;
        }

        .param-value {
            color: #6c757d;
            font-size: 0.9em;
            text-align: right;
            max-width: 60%;
            word-break: break-all;
        }

        .results-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .results-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .results-section h5 {
            color: #495057;
            margin: 15px 0 10px 0;
            font-size: 1.1em;
        }

        .config-edit-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-edit-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
            
            .config-details-grid {
                grid-template-columns: 1fr;
            }
            
            .config-param {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .param-value {
                max-width: 100%;
                text-align: left;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Passivbot 增强版配置平台</h1>
            <p>配置生成 | 在线回测 | 结果分析</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('config')">⚙️ 配置管理</button>
            <button class="nav-tab" onclick="switchTab('backtest')">📊 回测执行</button>
            <button class="nav-tab" onclick="switchTab('results')">📈 结果分析</button>
            <button class="nav-tab" onclick="switchTab('config-manage')">🔧 配置工具</button>
        </div>

        <!-- 配置管理标签页 -->
        <div id="config" class="tab-content active">
            <div class="form-section">
                <h3>📋 基础配置</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>回测开始日期</label>
                        <input type="date" id="start_date" value="2024-01-01">
                    </div>
                    <div class="form-group">
                        <label>回测结束日期</label>
                        <input type="date" id="end_date" value="2024-01-31">
                    </div>
                    <div class="form-group">
                        <label>初始资金</label>
                        <input type="number" id="starting_balance" value="10000" min="1000" step="1000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>交易所</label>
                        <select id="exchange">
                            <option value="binance">Binance</option>
                            <option value="okx">OKX</option>
                            <option value="bybit">Bybit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>交易对</label>
                        <select id="symbol">
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>📈 多头策略参数</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>入场网格间距 (%)</label>
                        <input type="number" id="entry_grid_spacing_pct" value="0.01" min="0.001" max="0.1" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>初始入场数量 (%)</label>
                        <input type="number" id="entry_initial_qty_pct" value="0.01" min="0.001" max="0.1" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>最大持仓数</label>
                        <input type="number" id="n_positions" value="3" min="1" max="10" step="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>平仓网格起始 (%)</label>
                        <input type="number" id="close_grid_markup_start" value="0.002" min="0.001" max="0.05" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>平仓网格结束 (%)</label>
                        <input type="number" id="close_grid_markup_end" value="0.001" min="0.001" max="0.05" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>总资金暴露限制</label>
                        <input type="number" id="total_wallet_exposure_limit" value="0.5" min="0.1" max="2.0" step="0.1">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>📉 空头策略参数</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>入场网格间距 (%)</label>
                        <input type="number" id="short_entry_grid_spacing_pct" value="0.01" min="0.001" max="0.1" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>初始入场数量 (%)</label>
                        <input type="number" id="short_entry_initial_qty_pct" value="0.01" min="0.001" max="0.1" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>最大持仓数</label>
                        <input type="number" id="short_n_positions" value="3" min="1" max="10" step="1">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>🎯 预设配置</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="loadPreset('conservative')">保守型</button>
                    <button class="btn btn-primary" onclick="loadPreset('moderate')">稳健型</button>
                    <button class="btn btn-primary" onclick="loadPreset('aggressive')">激进型</button>
                </div>
            </div>

            <div class="form-section">
                <h3>💾 配置操作</h3>
                <div>
                    <button class="btn btn-success" onclick="saveConfig()">💾 保存配置到服务器</button>
                    <button class="btn btn-primary" onclick="generateConfig()">📄 生成配置文件</button>
                    <button class="btn btn-warning" onclick="resetForm()">🔄 重置表单</button>
                </div>
            </div>

            <div id="config-result" class="results-panel" style="display: none;">
                <h4>📄 生成的配置</h4>
                <div class="code-block" id="config-json"></div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="copyConfig()">📋 复制配置</button>
                    <button class="btn btn-success" onclick="downloadConfig()">💾 下载配置</button>
                </div>
            </div>
        </div>

        <!-- 回测执行标签页 -->
        <div id="backtest" class="tab-content">
            <div class="status-panel">
                <h3>📊 系统状态</h3>
                <div class="status-item">
                    <span class="status-label">服务器状态</span>
                    <span class="status-value" id="server-status">检查中...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">配置文件</span>
                    <span class="status-value" id="config-status">检查中...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">最新回测</span>
                    <span class="status-value" id="latest-backtest">检查中...</span>
                </div>
            </div>

            <div class="form-section">
                <h3>🚀 回测执行</h3>
                <div class="alert alert-info">
                    <strong>💡 提示:</strong> 回测执行需要较长时间，请耐心等待。建议先保存配置再进行回测。
                </div>
                <div>
                    <button class="btn btn-success" onclick="runBacktest()" id="run-backtest-btn">
                        🚀 开始回测
                    </button>
                    <button class="btn btn-warning" onclick="refreshStatus()">
                        🔄 刷新状态
                    </button>
                </div>
            </div>

            <div class="loading" id="backtest-loading">
                <div class="spinner"></div>
                <p>回测执行中，请耐心等待...</p>
                <p><small>这可能需要几分钟时间</small></p>
            </div>

            <div id="backtest-result" class="results-panel" style="display: none;">
                <h4>📊 回测执行结果</h4>
                <div id="backtest-output" class="code-block"></div>
            </div>
        </div>

        <!-- 结果分析标签页 -->
        <div id="results" class="tab-content">
            <div class="form-section">
                <h3>📈 回测结果分析</h3>
                <div>
                    <button class="btn btn-primary" onclick="loadResults()">🔄 加载最新结果</button>
                    <button class="btn btn-success" onclick="exportResults()">📊 导出结果</button>
                </div>
            </div>

            <div id="results-content">
                <div class="alert alert-info">
                    点击"加载最新结果"查看回测分析数据
                </div>
            </div>
        </div>

        <!-- 配置工具标签页 -->
        <div id="config-manage" class="tab-content">
            <div class="form-section">
                <h3>🔧 配置管理工具</h3>
                <div class="alert alert-info">
                    <strong>💡 提示:</strong> 管理本地配置文件和网页服务配置文件的同步。
                </div>
                <div>
                    <button class="btn btn-primary" onclick="loadConfigStatus()">🔄 刷新配置状态</button>
                    <button class="btn btn-success" onclick="useWebConfig()">📥 使用网页配置</button>
                    <button class="btn btn-warning" onclick="backupConfig()">💾 备份当前配置</button>
                </div>
            </div>

            <div class="status-panel">
                <h3>📊 配置状态</h3>
                <div class="status-item">
                    <span class="status-label">本地配置文件</span>
                    <span class="status-value" id="local-config-status">检查中...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">网页服务配置</span>
                    <span class="status-value" id="web-config-status">检查中...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">配置备份数量</span>
                    <span class="status-value" id="backup-count">检查中...</span>
                </div>
            </div>

            <div class="form-section">
                <h3>📋 配置详情</h3>
                <div id="config-details">
                    <div class="alert alert-info">
                        点击"刷新配置状态"查看详细配置信息
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>✏️ 配置参数编辑</h3>
                <div class="alert alert-info">
                    <strong>💡 提示:</strong> 编辑配置参数后需要保存到服务器才能生效。
                </div>
                <div>
                    <button class="btn btn-primary" onclick="loadConfigForEdit()">📥 加载配置进行编辑</button>
                    <button class="btn btn-success" onclick="saveEditedConfig()">💾 保存编辑的配置</button>
                    <button class="btn btn-warning" onclick="resetEditedConfig()">🔄 重置编辑</button>
                </div>
            </div>

            <div id="config-edit-panel" class="form-section" style="display: none;">
                <h3>📝 编辑配置参数</h3>
                
                <!-- 回测配置 -->
                <div class="config-edit-section">
                    <h4>📊 回测配置</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>开始日期</label>
                            <input type="date" id="edit_start_date">
                        </div>
                        <div class="form-group">
                            <label>结束日期</label>
                            <input type="date" id="edit_end_date">
                        </div>
                        <div class="form-group">
                            <label>初始资金</label>
                            <input type="number" id="edit_starting_balance" min="1000" step="1000">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>交易所</label>
                            <select id="edit_exchange">
                                <option value="binance">Binance</option>
                                <option value="okx">OKX</option>
                                <option value="bybit">Bybit</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 多头策略配置 -->
                <div class="config-edit-section">
                    <h4>📈 多头策略配置</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>入场网格间距 (%)</label>
                            <input type="number" id="edit_entry_grid_spacing_pct" min="0.001" max="0.1" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>初始入场数量 (%)</label>
                            <input type="number" id="edit_entry_initial_qty_pct" min="0.001" max="0.1" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>最大持仓数</label>
                            <input type="number" id="edit_n_positions" min="1" max="10" step="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>平仓网格起始 (%)</label>
                            <input type="number" id="edit_close_grid_markup_start" min="0.001" max="0.05" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>平仓网格结束 (%)</label>
                            <input type="number" id="edit_close_grid_markup_end" min="0.001" max="0.05" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>总资金暴露限制</label>
                            <input type="number" id="edit_total_wallet_exposure_limit" min="0.1" max="2.0" step="0.1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>EMA周期0</label>
                            <input type="number" id="edit_ema_span_0" min="10" max="1000" step="1">
                        </div>
                        <div class="form-group">
                            <label>EMA周期1</label>
                            <input type="number" id="edit_ema_span_1" min="10" max="1000" step="1">
                        </div>
                    </div>
                </div>

                <!-- 空头策略配置 -->
                <div class="config-edit-section">
                    <h4>📉 空头策略配置</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>入场网格间距 (%)</label>
                            <input type="number" id="edit_short_entry_grid_spacing_pct" min="0.001" max="0.1" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>初始入场数量 (%)</label>
                            <input type="number" id="edit_short_entry_initial_qty_pct" min="0.001" max="0.1" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>最大持仓数</label>
                            <input type="number" id="edit_short_n_positions" min="1" max="10" step="1">
                        </div>
                    </div>
                </div>

                <!-- 实盘配置 -->
                <div class="config-edit-section">
                    <h4>🚀 实盘配置</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>交易对</label>
                            <select id="edit_symbol">
                                <option value="BTCUSDT">BTC/USDT</option>
                                <option value="ETHUSDT">ETH/USDT</option>
                                <option value="ADAUSDT">ADA/USDT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>杠杆倍数</label>
                            <input type="number" id="edit_leverage" min="1" max="100" step="1">
                        </div>
                        <div class="form-group">
                            <label>用户标识</label>
                            <input type="text" id="edit_user" placeholder="输入用户标识">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>订单有效期</label>
                            <select id="edit_time_in_force">
                                <option value="GTC">GTC (撤销前有效)</option>
                                <option value="IOC">IOC (立即成交或撤销)</option>
                                <option value="FOK">FOK (全部成交或撤销)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>执行延迟 (秒)</label>
                            <input type="number" id="edit_execution_delay_seconds" min="0" max="60" step="1">
                        </div>
                        <div class="form-group">
                            <label>最小币龄 (天)</label>
                            <input type="number" id="edit_minimum_coin_age_days" min="1" max="365" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>🚀 快速操作</h3>
                <div class="alert alert-warning">
                    <strong>⚠️ 重要:</strong> 使用网页配置会覆盖当前本地配置，请确保已备份重要配置。
                </div>
                <div>
                    <button class="btn btn-success" onclick="setWebConfigActive()">
                        🎯 设置网页配置为活动配置
                    </button>
                    <button class="btn btn-primary" onclick="openQuickStart()">
                        🚀 打开快速启动脚本
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 标签页切换
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签的激活状态
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabName).classList.add('active');
            
            // 激活对应的标签
            event.target.classList.add('active');
            
            // 如果切换到结果页面，自动加载结果
            if (tabName === 'results') {
                loadResults();
            }
            
            // 如果切换到配置管理页面，自动加载配置状态
            if (tabName === 'config-manage') {
                loadConfigStatus();
            }
        }

        // 加载预设配置
        function loadPreset(type) {
            const presets = {
                conservative: {
                    entry_grid_spacing_pct: 0.005,
                    entry_initial_qty_pct: 0.005,
                    n_positions: 2,
                    close_grid_markup_start: 0.001,
                    close_grid_markup_end: 0.0005,
                    total_wallet_exposure_limit: 0.3
                },
                moderate: {
                    entry_grid_spacing_pct: 0.01,
                    entry_initial_qty_pct: 0.01,
                    n_positions: 3,
                    close_grid_markup_start: 0.002,
                    close_grid_markup_end: 0.001,
                    total_wallet_exposure_limit: 0.5
                },
                aggressive: {
                    entry_grid_spacing_pct: 0.02,
                    entry_initial_qty_pct: 0.02,
                    n_positions: 5,
                    close_grid_markup_start: 0.005,
                    close_grid_markup_end: 0.002,
                    total_wallet_exposure_limit: 1.0
                }
            };

            const preset = presets[type];
            for (const [key, value] of Object.entries(preset)) {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            }
            
            showAlert('success', `已加载${type === 'conservative' ? '保守型' : type === 'moderate' ? '稳健型' : '激进型'}配置`);
        }

        // 生成配置
        function generateConfig() {
            const config = {
                backtest: {
                    base_dir: "backtests",
                    combine_ohlcvs: true,
                    compress_cache: true,
                    start_date: document.getElementById('start_date').value,
                    end_date: document.getElementById('end_date').value,
                    starting_balance: parseInt(document.getElementById('starting_balance').value),
                    exchanges: [document.getElementById('exchange').value],
                    gap_tolerance_ohlcvs_minutes: 120,
                    use_btc_collateral: true
                },
                bot: {
                    long: {
                        close_grid_markup_end: parseFloat(document.getElementById('close_grid_markup_end').value),
                        close_grid_markup_start: parseFloat(document.getElementById('close_grid_markup_start').value),
                        close_grid_qty_pct: 0.5,
                        close_trailing_grid_ratio: 0.0,
                        close_trailing_qty_pct: 0.0,
                        close_trailing_retracement_pct: 0.0,
                        close_trailing_threshold_pct: 0.0,
                        ema_span_0: 100,
                        ema_span_1: 200,
                        enforce_exposure_limit: true,
                        entry_grid_double_down_factor: 1.0,
                        entry_grid_spacing_pct: parseFloat(document.getElementById('entry_grid_spacing_pct').value),
                        entry_grid_spacing_weight: 1.0,
                        entry_initial_ema_dist: 0.0,
                        entry_initial_qty_pct: parseFloat(document.getElementById('entry_initial_qty_pct').value),
                        entry_trailing_double_down_factor: 1.0,
                        entry_trailing_grid_ratio: 0.0,
                        entry_trailing_retracement_pct: 0.0,
                        entry_trailing_threshold_pct: 0.0,
                        filter_noisiness_rolling_window: 20,
                        filter_volume_drop_pct: 0.0,
                        filter_volume_rolling_window: 100,
                        n_positions: parseInt(document.getElementById('n_positions').value),
                        total_wallet_exposure_limit: parseFloat(document.getElementById('total_wallet_exposure_limit').value),
                        unstuck_close_pct: 0.01,
                        unstuck_ema_dist: 0.001,
                        unstuck_loss_allowance_pct: 0.001,
                        unstuck_threshold: 0.5
                    },
                    short: {
                        close_grid_markup_end: parseFloat(document.getElementById('close_grid_markup_end').value),
                        close_grid_markup_start: parseFloat(document.getElementById('close_grid_markup_start').value),
                        close_grid_qty_pct: 0.5,
                        close_trailing_grid_ratio: 0.0,
                        close_trailing_qty_pct: 0.0,
                        close_trailing_retracement_pct: 0.0,
                        close_trailing_threshold_pct: 0.0,
                        ema_span_0: 100,
                        ema_span_1: 200,
                        enforce_exposure_limit: true,
                        entry_grid_double_down_factor: 1.0,
                        entry_grid_spacing_pct: parseFloat(document.getElementById('short_entry_grid_spacing_pct').value),
                        entry_grid_spacing_weight: 1.0,
                        entry_initial_ema_dist: 0.0,
                        entry_initial_qty_pct: parseFloat(document.getElementById('short_entry_initial_qty_pct').value),
                        entry_trailing_double_down_factor: 1.0,
                        entry_trailing_grid_ratio: 0.0,
                        entry_trailing_retracement_pct: 0.0,
                        entry_trailing_threshold_pct: 0.0,
                        filter_noisiness_rolling_window: 20,
                        filter_volume_drop_pct: 0.0,
                        filter_volume_rolling_window: 100,
                        n_positions: parseInt(document.getElementById('short_n_positions').value),
                        total_wallet_exposure_limit: parseFloat(document.getElementById('total_wallet_exposure_limit').value),
                        unstuck_close_pct: 0.01,
                        unstuck_ema_dist: 0.001,
                        unstuck_loss_allowance_pct: 0.001,
                        unstuck_threshold: 0.5
                    }
                },
                live: {
                    approved_coins: [document.getElementById('symbol').value],
                    auto_gs: false,
                    empty_means_all_approved: false,
                    execution_delay_seconds: 0,
                    filter_by_min_effective_cost: false,
                    forced_mode_long: "n",
                    forced_mode_short: "n",
                    ignored_coins: { long: [], short: [] },
                    leverage: 1.0,
                    market_orders_allowed: false,
                    max_n_cancellations_per_batch: 100,
                    max_n_creations_per_batch: 100,
                    max_n_restarts_per_day: 10,
                    mimic_backtest_1m_delay: false,
                    minimum_coin_age_days: 30,
                    ohlcvs_1m_rolling_window_days: 7,
                    ohlcvs_1m_update_after_minutes: 1,
                    pnls_max_lookback_days: 30,
                    price_distance_threshold: 0.002,
                    time_in_force: "GTC",
                    user: "web_user"
                }
            };

            document.getElementById('config-json').textContent = JSON.stringify(config, null, 2);
            document.getElementById('config-result').style.display = 'block';
            
            showAlert('success', '配置生成成功！');
        }

        // 保存配置到服务器
        async function saveConfig() {
            generateConfig(); // 先生成配置
            
            const configText = document.getElementById('config-json').textContent;
            const config = JSON.parse(configText);
            
            try {
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message);
                    refreshStatus(); // 刷新状态
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                showAlert('danger', '保存配置失败: ' + error.message);
            }
        }

        // 运行回测
        async function runBacktest() {
            const btn = document.getElementById('run-backtest-btn');
            const loading = document.getElementById('backtest-loading');
            const result = document.getElementById('backtest-result');
            
            btn.disabled = true;
            loading.style.display = 'block';
            result.style.display = 'none';
            
            try {
                const response = await fetch('/api/run-backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message);
                    
                    // 开始轮询结果
                    pollBacktestResults();
                } else {
                    showAlert('danger', data.message);
                    btn.disabled = false;
                    loading.style.display = 'none';
                }
            } catch (error) {
                showAlert('danger', '启动回测失败: ' + error.message);
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // 轮询回测结果
        async function pollBacktestResults() {
            const maxAttempts = 60; // 最多轮询60次
            let attempts = 0;
            
            const poll = async () => {
                attempts++;
                
                try {
                    const response = await fetch('/api/backtest/results');
                    const data = await response.json();
                    
                    if (data.execution && data.execution.timestamp > 0) {
                        // 回测完成
                        document.getElementById('backtest-loading').style.display = 'none';
                        document.getElementById('run-backtest-btn').disabled = false;
                        
                        const output = document.getElementById('backtest-output');
                        if (data.execution.success) {
                            output.textContent = data.execution.stdout || '回测执行成功';
                            showAlert('success', '回测执行完成！');
                        } else {
                            output.textContent = data.execution.stderr || data.execution.error || '回测执行失败';
                            showAlert('danger', '回测执行失败');
                        }
                        
                        document.getElementById('backtest-result').style.display = 'block';
                        refreshStatus();
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000); // 5秒后再次检查
                    } else {
                        document.getElementById('backtest-loading').style.display = 'none';
                        document.getElementById('run-backtest-btn').disabled = false;
                        showAlert('warning', '回测超时，请手动检查结果');
                    }
                } catch (error) {
                    console.error('轮询回测结果失败:', error);
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    }
                }
            };
            
            poll();
        }

        // 加载回测结果
        async function loadResults() {
            try {
                const response = await fetch('/api/backtest/results');
                const data = await response.json();
                
                const resultsContent = document.getElementById('results-content');
                
                if (data.analysis) {
                    const analysis = data.analysis;
                    
                    // 计算关键指标
                    const initialBalance = 10000;
                    const finalBalance = initialBalance * (1 + analysis.gain);
                    const totalProfit = finalBalance - initialBalance;
                    const totalReturn = analysis.gain * 100;
                    
                    resultsContent.innerHTML = `
                        <div class="results-section">
                            <h4>💰 核心盈利指标</h4>
                            <div class="metric-grid">
                                <div class="metric-card">
                                    <div class="metric-value">$${initialBalance.toLocaleString()}</div>
                                    <div class="metric-label">初始资金</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">$${finalBalance.toLocaleString()}</div>
                                    <div class="metric-label">最终资金</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">$${totalProfit.toLocaleString()}</div>
                                    <div class="metric-label">总收益</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${totalReturn.toFixed(2)}%</div>
                                    <div class="metric-label">总收益率</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="results-section">
                            <h4>📊 风险指标</h4>
                            <div class="metric-grid">
                                <div class="metric-card">
                                    <div class="metric-value">${(analysis.drawdown_worst * 100).toFixed(2)}%</div>
                                    <div class="metric-label">最大回撤</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${analysis.sharpe_ratio.toFixed(4)}</div>
                                    <div class="metric-label">夏普比率</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${analysis.sortino_ratio.toFixed(4)}</div>
                                    <div class="metric-label">索提诺比率</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${analysis.positions_held_per_day.toFixed(1)}</div>
                                    <div class="metric-label">日均持仓数</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="results-section">
                            <h4>📈 交易统计</h4>
                            <div class="metric-grid">
                                <div class="metric-card">
                                    <div class="metric-value">${analysis.position_held_hours_mean.toFixed(2)}h</div>
                                    <div class="metric-label">平均持仓时间</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${analysis.position_held_hours_max.toFixed(2)}h</div>
                                    <div class="metric-label">最长持仓时间</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-success">
                            <strong>✅ 回测分析完成！</strong> 详细数据已保存到服务器。
                        </div>
                    `;
                } else {
                    resultsContent.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>⚠️ 暂无回测结果</strong> 请先执行回测。
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('results-content').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>❌ 加载结果失败:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // 刷新状态
        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('server-status').textContent = data.status;
                document.getElementById('server-status').className = 'status-value success';
                
                document.getElementById('config-status').textContent = data.config_exists ? '已存在' : '不存在';
                document.getElementById('config-status').className = data.config_exists ? 'status-value success' : 'status-value error';
                
                document.getElementById('latest-backtest').textContent = data.backtest_dir ? '有数据' : '无数据';
                document.getElementById('latest-backtest').className = data.backtest_dir ? 'status-value success' : 'status-value warning';
            } catch (error) {
                document.getElementById('server-status').textContent = '连接失败';
                document.getElementById('server-status').className = 'status-value error';
            }
        }

        // 显示提示信息
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<strong>${type === 'success' ? '✅' : type === 'danger' ? '❌' : '⚠️'}</strong> ${message}`;
            
            // 插入到当前标签页的顶部
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(alertDiv, activeTab.firstChild);
            
            // 3秒后自动移除
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 复制配置
        function copyConfig() {
            const configText = document.getElementById('config-json').textContent;
            navigator.clipboard.writeText(configText).then(() => {
                showAlert('success', '配置已复制到剪贴板');
            }).catch(() => {
                showAlert('danger', '复制失败，请手动复制');
            });
        }

        // 下载配置
        function downloadConfig() {
            const configText = document.getElementById('config-json').textContent;
            const blob = new Blob([configText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my_config.json';
            a.click();
            URL.revokeObjectURL(url);
            showAlert('success', '配置文件已下载');
        }

        // 重置表单
        function resetForm() {
            document.querySelectorAll('input, select').forEach(element => {
                if (element.type === 'date') {
                    element.value = element.id === 'start_date' ? '2024-01-01' : '2024-01-31';
                } else if (element.type === 'number') {
                    element.value = element.defaultValue || '0';
                } else if (element.tagName === 'SELECT') {
                    element.selectedIndex = 0;
                }
            });
            document.getElementById('config-result').style.display = 'none';
            showAlert('info', '表单已重置');
        }

        // 导出结果
        function exportResults() {
            showAlert('info', '导出功能开发中...');
        }

        // 加载配置状态
        async function loadConfigStatus() {
            try {
                const response = await fetch('/api/config/status');
                const data = await response.json();
                
                // 更新状态显示
                document.getElementById('local-config-status').textContent = 
                    data.local_config.exists ? '存在' : '不存在';
                document.getElementById('local-config-status').className = 
                    data.local_config.exists ? 'status-value success' : 'status-value error';
                
                document.getElementById('web-config-status').textContent = 
                    data.web_config.exists ? '存在' : '不存在';
                document.getElementById('web-config-status').className = 
                    data.web_config.exists ? 'status-value success' : 'status-value error';
                
                document.getElementById('backup-count').textContent = 
                    `${data.backups.length} 个备份`;
                document.getElementById('backup-count').className = 
                    data.backups.length > 0 ? 'status-value success' : 'status-value warning';
                
                // 显示配置详情
                const detailsDiv = document.getElementById('config-details');
                let detailsHtml = '<div class="metric-grid">';
                
                if (data.local_config.exists) {
                    detailsHtml += `
                        <div class="metric-card">
                            <div class="metric-value">本地配置</div>
                            <div class="metric-label">大小: ${(data.local_config.size / 1024).toFixed(1)} KB</div>
                            <div class="metric-label">修改: ${new Date(data.local_config.modified * 1000).toLocaleString()}</div>
                        </div>
                    `;
                }
                
                if (data.web_config.exists) {
                    detailsHtml += `
                        <div class="metric-card">
                            <div class="metric-value">网页配置</div>
                            <div class="metric-label">大小: ${(data.web_config.size / 1024).toFixed(1)} KB</div>
                            <div class="metric-label">修改: ${new Date(data.web_config.modified * 1000).toLocaleString()}</div>
                        </div>
                    `;
                }
                
                if (data.backups.length > 0) {
                    detailsHtml += `
                        <div class="metric-card">
                            <div class="metric-value">${data.backups.length}</div>
                            <div class="metric-label">配置备份</div>
                            <div class="metric-label">最新: ${new Date(data.backups[0].modified * 1000).toLocaleString()}</div>
                        </div>
                    `;
                }
                
                detailsHtml += '</div>';
                
                // 显示配置参数详情
                if (data.config_details) {
                    detailsHtml += '<div class="results-section">';
                    detailsHtml += '<h4>📋 配置参数详情</h4>';
                    
                    // 显示本地配置参数
                    if (data.config_details.local_config) {
                        detailsHtml += '<h5>💻 本地配置参数</h5>';
                        detailsHtml += formatConfigDetails(data.config_details.local_config);
                    }
                    
                    // 显示网页配置参数
                    if (data.config_details.web_config) {
                        detailsHtml += '<h5>🌐 网页配置参数</h5>';
                        detailsHtml += formatConfigDetails(data.config_details.web_config);
                    }
                    
                    detailsHtml += '</div>';
                }
                
                if (data.backups.length > 0) {
                    detailsHtml += '<div class="results-section">';
                    detailsHtml += '<h4>📁 备份文件列表</h4><ul>';
                    data.backups.slice(0, 5).forEach(backup => {
                        detailsHtml += `<li>${backup.name} (${new Date(backup.modified * 1000).toLocaleString()})</li>`;
                    });
                    if (data.backups.length > 5) {
                        detailsHtml += `<li>... 还有 ${data.backups.length - 5} 个备份</li>`;
                    }
                    detailsHtml += '</ul></div>';
                }
                
                detailsDiv.innerHTML = detailsHtml;
                
            } catch (error) {
                showAlert('danger', '加载配置状态失败: ' + error.message);
            }
        }

        // 使用网页配置
        async function useWebConfig() {
            if (!confirm('确定要使用网页服务配置吗？这将覆盖当前本地配置。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/config/use-web', {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message);
                    loadConfigStatus(); // 刷新状态
                } else {
                    showAlert('danger', data.message);
                }
            } catch (error) {
                showAlert('danger', '使用网页配置失败: ' + error.message);
            }
        }

        // 备份配置
        async function backupConfig() {
            try {
                const response = await fetch('/api/config/backup', {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message);
                    loadConfigStatus(); // 刷新状态
                } else {
                    showAlert('danger', data.message);
                }
            } catch (error) {
                showAlert('danger', '备份配置失败: ' + error.message);
            }
        }

        // 设置网页配置为活动配置
        async function setWebConfigActive() {
            if (!confirm('确定要设置网页配置为活动配置吗？这将覆盖当前本地配置。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/config/set-active', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ source: 'web' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', data.message);
                    loadConfigStatus(); // 刷新状态
                } else {
                    showAlert('danger', data.message);
                }
            } catch (error) {
                showAlert('danger', '设置活动配置失败: ' + error.message);
            }
        }

        // 格式化配置详情
        function formatConfigDetails(config) {
            let html = '<div class="config-details-grid">';
            
            // 回测配置
            if (config.backtest && Object.keys(config.backtest).length > 0) {
                html += '<div class="config-section">';
                html += '<h6>📊 回测配置</h6>';
                html += '<div class="config-params">';
                for (const [key, value] of Object.entries(config.backtest)) {
                    html += `<div class="config-param"><span class="param-name">${key}:</span> <span class="param-value">${Array.isArray(value) ? value.join(', ') : value}</span></div>`;
                }
                html += '</div></div>';
            }
            
            // 多头策略配置
            if (config.bot && config.bot.long && Object.keys(config.bot.long).length > 0) {
                html += '<div class="config-section">';
                html += '<h6>📈 多头策略配置</h6>';
                html += '<div class="config-params">';
                for (const [key, value] of Object.entries(config.bot.long)) {
                    html += `<div class="config-param"><span class="param-name">${key}:</span> <span class="param-value">${value}</span></div>`;
                }
                html += '</div></div>';
            }
            
            // 空头策略配置
            if (config.bot && config.bot.short && Object.keys(config.bot.short).length > 0) {
                html += '<div class="config-section">';
                html += '<h6>📉 空头策略配置</h6>';
                html += '<div class="config-params">';
                for (const [key, value] of Object.entries(config.bot.short)) {
                    html += `<div class="config-param"><span class="param-name">${key}:</span> <span class="param-value">${value}</span></div>`;
                }
                html += '</div></div>';
            }
            
            // 实盘配置
            if (config.live && Object.keys(config.live).length > 0) {
                html += '<div class="config-section">';
                html += '<h6>🚀 实盘配置</h6>';
                html += '<div class="config-params">';
                for (const [key, value] of Object.entries(config.live)) {
                    html += `<div class="config-param"><span class="param-name">${key}:</span> <span class="param-value">${Array.isArray(value) ? value.join(', ') : value}</span></div>`;
                }
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }

        // 加载配置进行编辑
        async function loadConfigForEdit() {
            try {
                const response = await fetch('/api/config/status');
                const data = await response.json();
                
                let configToLoad = null;
                
                // 优先使用网页配置，如果没有则使用本地配置
                if (data.config_details && data.config_details.web_config) {
                    configToLoad = data.config_details.web_config;
                    showAlert('info', '已加载网页配置进行编辑');
                } else if (data.config_details && data.config_details.local_config) {
                    configToLoad = data.config_details.local_config;
                    showAlert('info', '已加载本地配置进行编辑');
                } else {
                    showAlert('warning', '没有找到可编辑的配置');
                    return;
                }
                
                // 填充表单
                fillEditForm(configToLoad);
                
                // 显示编辑面板
                document.getElementById('config-edit-panel').style.display = 'block';
                
            } catch (error) {
                showAlert('danger', '加载配置失败: ' + error.message);
            }
        }

        // 填充编辑表单
        function fillEditForm(config) {
            // 回测配置
            if (config.backtest) {
                document.getElementById('edit_start_date').value = config.backtest.start_date || '';
                document.getElementById('edit_end_date').value = config.backtest.end_date || '';
                document.getElementById('edit_starting_balance').value = config.backtest.starting_balance || '';
                document.getElementById('edit_exchange').value = config.backtest.exchanges?.[0] || 'binance';
            }
            
            // 多头策略配置
            if (config.bot && config.bot.long) {
                const long = config.bot.long;
                document.getElementById('edit_entry_grid_spacing_pct').value = long.entry_grid_spacing_pct || '';
                document.getElementById('edit_entry_initial_qty_pct').value = long.entry_initial_qty_pct || '';
                document.getElementById('edit_n_positions').value = long.n_positions || '';
                document.getElementById('edit_close_grid_markup_start').value = long.close_grid_markup_start || '';
                document.getElementById('edit_close_grid_markup_end').value = long.close_grid_markup_end || '';
                document.getElementById('edit_total_wallet_exposure_limit').value = long.total_wallet_exposure_limit || '';
                document.getElementById('edit_ema_span_0').value = long.ema_span_0 || '';
                document.getElementById('edit_ema_span_1').value = long.ema_span_1 || '';
            }
            
            // 空头策略配置
            if (config.bot && config.bot.short) {
                const short = config.bot.short;
                document.getElementById('edit_short_entry_grid_spacing_pct').value = short.entry_grid_spacing_pct || '';
                document.getElementById('edit_short_entry_initial_qty_pct').value = short.entry_initial_qty_pct || '';
                document.getElementById('edit_short_n_positions').value = short.n_positions || '';
            }
            
            // 实盘配置
            if (config.live) {
                const live = config.live;
                document.getElementById('edit_symbol').value = live.approved_coins?.[0] || 'BTCUSDT';
                document.getElementById('edit_leverage').value = live.leverage || '';
                document.getElementById('edit_user').value = live.user || '';
                document.getElementById('edit_time_in_force').value = live.time_in_force || 'GTC';
                document.getElementById('edit_execution_delay_seconds').value = live.execution_delay_seconds || '';
                document.getElementById('edit_minimum_coin_age_days').value = live.minimum_coin_age_days || '';
            }
        }

        // 保存编辑的配置
        async function saveEditedConfig() {
            try {
                // 收集表单数据
                const config = {
                    backtest: {
                        base_dir: "backtests",
                        combine_ohlcvs: true,
                        compress_cache: true,
                        start_date: document.getElementById('edit_start_date').value,
                        end_date: document.getElementById('edit_end_date').value,
                        starting_balance: parseInt(document.getElementById('edit_starting_balance').value),
                        exchanges: [document.getElementById('edit_exchange').value],
                        gap_tolerance_ohlcvs_minutes: 120,
                        use_btc_collateral: true
                    },
                    bot: {
                        long: {
                            close_grid_markup_end: parseFloat(document.getElementById('edit_close_grid_markup_end').value),
                            close_grid_markup_start: parseFloat(document.getElementById('edit_close_grid_markup_start').value),
                            close_grid_qty_pct: 0.5,
                            close_trailing_grid_ratio: 0.0,
                            close_trailing_qty_pct: 0.0,
                            close_trailing_retracement_pct: 0.0,
                            close_trailing_threshold_pct: 0.0,
                            ema_span_0: parseInt(document.getElementById('edit_ema_span_0').value),
                            ema_span_1: parseInt(document.getElementById('edit_ema_span_1').value),
                            enforce_exposure_limit: true,
                            entry_grid_double_down_factor: 1.0,
                            entry_grid_spacing_pct: parseFloat(document.getElementById('edit_entry_grid_spacing_pct').value),
                            entry_grid_spacing_weight: 1.0,
                            entry_initial_ema_dist: 0.0,
                            entry_initial_qty_pct: parseFloat(document.getElementById('edit_entry_initial_qty_pct').value),
                            entry_trailing_double_down_factor: 1.0,
                            entry_trailing_grid_ratio: 0.0,
                            entry_trailing_retracement_pct: 0.0,
                            entry_trailing_threshold_pct: 0.0,
                            filter_noisiness_rolling_window: 20,
                            filter_volume_drop_pct: 0.0,
                            filter_volume_rolling_window: 100,
                            n_positions: parseInt(document.getElementById('edit_n_positions').value),
                            total_wallet_exposure_limit: parseFloat(document.getElementById('edit_total_wallet_exposure_limit').value),
                            unstuck_close_pct: 0.01,
                            unstuck_ema_dist: 0.001,
                            unstuck_loss_allowance_pct: 0.001,
                            unstuck_threshold: 0.5
                        },
                        short: {
                            close_grid_markup_end: parseFloat(document.getElementById('edit_close_grid_markup_end').value),
                            close_grid_markup_start: parseFloat(document.getElementById('edit_close_grid_markup_start').value),
                            close_grid_qty_pct: 0.5,
                            close_trailing_grid_ratio: 0.0,
                            close_trailing_qty_pct: 0.0,
                            close_trailing_retracement_pct: 0.0,
                            close_trailing_threshold_pct: 0.0,
                            ema_span_0: parseInt(document.getElementById('edit_ema_span_0').value),
                            ema_span_1: parseInt(document.getElementById('edit_ema_span_1').value),
                            enforce_exposure_limit: true,
                            entry_grid_double_down_factor: 1.0,
                            entry_grid_spacing_pct: parseFloat(document.getElementById('edit_short_entry_grid_spacing_pct').value),
                            entry_grid_spacing_weight: 1.0,
                            entry_initial_ema_dist: 0.0,
                            entry_initial_qty_pct: parseFloat(document.getElementById('edit_short_entry_initial_qty_pct').value),
                            entry_trailing_double_down_factor: 1.0,
                            entry_trailing_grid_ratio: 0.0,
                            entry_trailing_retracement_pct: 0.0,
                            entry_trailing_threshold_pct: 0.0,
                            filter_noisiness_rolling_window: 20,
                            filter_volume_drop_pct: 0.0,
                            filter_volume_rolling_window: 100,
                            n_positions: parseInt(document.getElementById('edit_short_n_positions').value),
                            total_wallet_exposure_limit: parseFloat(document.getElementById('edit_total_wallet_exposure_limit').value),
                            unstuck_close_pct: 0.01,
                            unstuck_ema_dist: 0.001,
                            unstuck_loss_allowance_pct: 0.001,
                            unstuck_threshold: 0.5
                        }
                    },
                    live: {
                        approved_coins: [document.getElementById('edit_symbol').value],
                        auto_gs: false,
                        empty_means_all_approved: false,
                        execution_delay_seconds: parseInt(document.getElementById('edit_execution_delay_seconds').value),
                        filter_by_min_effective_cost: false,
                        forced_mode_long: "n",
                        forced_mode_short: "n",
                        ignored_coins: { long: [], short: [] },
                        leverage: parseFloat(document.getElementById('edit_leverage').value),
                        market_orders_allowed: false,
                        max_n_cancellations_per_batch: 100,
                        max_n_creations_per_batch: 100,
                        max_n_restarts_per_day: 10,
                        mimic_backtest_1m_delay: false,
                        minimum_coin_age_days: parseInt(document.getElementById('edit_minimum_coin_age_days').value),
                        ohlcvs_1m_rolling_window_days: 7,
                        ohlcvs_1m_update_after_minutes: 1,
                        pnls_max_lookback_days: 30,
                        price_distance_threshold: 0.002,
                        time_in_force: document.getElementById('edit_time_in_force').value,
                        user: document.getElementById('edit_user').value
                    }
                };
                
                // 保存到服务器
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', '配置已保存到服务器！');
                    loadConfigStatus(); // 刷新配置状态
                } else {
                    showAlert('danger', result.message);
                }
                
            } catch (error) {
                showAlert('danger', '保存配置失败: ' + error.message);
            }
        }

        // 重置编辑
        function resetEditedConfig() {
            // 清空所有编辑表单
            const editInputs = document.querySelectorAll('#config-edit-panel input, #config-edit-panel select');
            editInputs.forEach(input => {
                if (input.type === 'date') {
                    input.value = '';
                } else if (input.type === 'number') {
                    input.value = '';
                } else if (input.type === 'text') {
                    input.value = '';
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                }
            });
            
            showAlert('info', '编辑表单已重置');
        }

        // 打开快速启动脚本
        function openQuickStart() {
            showAlert('info', '请在新终端中运行: ./quick_start.sh config-manage');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            
            // 每30秒自动刷新状态
            setInterval(refreshStatus, 30000);
        });
    </script>
</body>
</html>